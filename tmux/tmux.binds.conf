unbind C-h
unbind C-j
unbind C-k
unbind C-l
# unbind -a -T root
# unbind -a -T PANE_MODE
# unbind -a -T WINDOW_MODE
# unbind -a -T SESSION_MODE
# unbind -a -T RESIZE_MODE
unbind-key -a
set-option -g prefix C-b

##### Global keys like in Zellij (no prefix) #####
# bind -n C-h select-pane -L
# bind -n C-j select-pane -D
# bind -n C-k select-pane -U
# bind -n C-l select-pane -R

# Mouse bindings
bind -T root MouseDown1Status  select-window -t=
bind -T root MouseUp1Status    select-window -t=
bind -T root MouseDown3Status  select-window -t=
bind -T root MouseDown1Pane    if -F '#{mouse_any_flag}' 'select-pane -t=; send-keys -M' 'select-pane -t='
bind -T root MouseUp1Pane      if -F '#{mouse_any_flag}' 'select-pane -t=; send-keys -M' 'select-pane -t='
bind -T root MouseDrag1Pane    if -F '#{mouse_any_flag}' 'send-keys -M' 'if -Ft= "#{pane_in_mode}" "send-keys -M" "copy-mode -e; send-keys -M"'
bind -T root MouseDrag1Border  resize-pane -M
bind -T copy-mode-vi WheelUpPane   send -X scroll-up
bind -T copy-mode-vi WheelDownPane send -X scroll-down


# set -g mouse on
# set -g set-clipboard on
bind -T copy-mode-vi v send-keys -X begin-selection
# bind -T copy-mode-vi y send-keys -X copy-pipe "pbcopy -i -selection clipboard"
set -g mouse on
set -g set-clipboard external
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe "pbcopy"

# Smart pane switching with awareness of Vim splits.
vim_pattern='(\S+/)?g?\.?(view|l?n?vim?x?|fzf)(diff)?(-wrapped)?'
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +${vim_pattern}$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'
tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l




# Modes
unbind -n C-x
unbind -n C-x
bind -n C-M-a switch-client -T PANE_MODE
unbind C-w
bind -n C-M-w switch-client -T WINDOW_MODE
bind -n C-M-x switch-client -T SESSION_MODE
bind -n C-M-n switch-client -T RESIZE_MODE
unbind -n C-s
bind -n C-M-s copy-mode -e


# Alt-navigation through panels/tabs and layouts
unbind -n M-Up
unbind -n M-Down
unbind -n M-Left
unbind -n M-Right
bind -n M-Left if -F '#{pane_at_left}'  'previous-window' 'select-pane -L'
bind -n M-Right if -F '#{pane_at_right}' 'next-window'     'select-pane -R'
bind -n M-Down select-pane -D
bind -n M-Up select-pane -U

bind -n "M-{" select-layout -p
bind -n "M-}" select-layout -n

bind -n M-n split-window -v

bind -n M-w kill-pane

# Quick selection of tabs 1..9
bind -n 'M-1' select-window -t 1
bind -n 'M-2' select-window -t 2
bind -n 'M-3' select-window -t 3
bind -n 'M-4' select-window -t 4
bind -n 'M-5' select-window -t 5
bind -n 'M-6' select-window -t 6
bind -n 'M-7' select-window -t 7
bind -n 'M-8' select-window -t 8
bind -n 'M-9' select-window -t 9




##### Pane mode (Zellij: Pane) #####
# Move between panels and quick actions, then exit to NORMAL
bind -T PANE_MODE h select-pane -L \; switch-client -T root
bind -T PANE_MODE j select-pane -D \; switch-client -T root
bind -T PANE_MODE k select-pane -U \; switch-client -T root
bind -T PANE_MODE l select-pane -R \; switch-client -T root
bind -T PANE_MODE p last-pane \; switch-client -T root
bind -T PANE_MODE o select-pane -t + \; switch-client -T root
bind -T PANE_MODE s split-window -h \; switch-client -T root
bind -T PANE_MODE v split-window -v \; switch-client -T root
bind -T PANE_MODE x kill-pane \; switch-client -T root
bind -T PANE_MODE z resize-pane -Z \; switch-client -T root


# Broadcast input (Sync panes)
bind -T PANE_MODE S set -w synchronize-panes \; display-message "Sync: #{?window_sync,ON,OFF}" \; switch-client -T root


# Toggle pane frames (как TogglePaneFrames)
unbind -T PANE_MODE f
set -g @pane_frames off
# bind -T PANE_MODE f if -F '#{==:#{@pane_frames},on}' 'set -g @pane_frames off' 'set -g @pane_frames on'
bind -T PANE_MODE f {
  if -F '#{==:#{@pane_frames},on}' {
    set -g @pane_frames off
  } {
    set -g @pane_frames on
  }
}



# # "Floating": popup as a surrogate
# bind -T PANE_MODE w run-shell "$XDG_CONFIG_HOME/tmux/scripts/popup.sh" #TODO:fix the damn bug with PATH


# MovePane: select a target and swap
unbind -T PANE_MODE t
bind -T PANE_MODE t display-panes -d 0 'swap-pane -s ! -t "%%"'


##### Window (Tab) mode #####
bind -T WINDOW_MODE r command-prompt -I "#W" { rename-window "%%" }
bind -T WINDOW_MODE h previous-window \; switch-client -T root
bind -T WINDOW_MODE k previous-window \; switch-client -T root
bind -T WINDOW_MODE Up previous-window \; switch-client -T root
bind -T WINDOW_MODE l next-window \; switch-client -T root
bind -T WINDOW_MODE j next-window \; switch-client -T root
bind -T WINDOW_MODE Down next-window \; switch-client -T root
bind -T WINDOW_MODE n new-window \; switch-client -T root
bind -T WINDOW_MODE x kill-window \; switch-client -T root
bind -T WINDOW_MODE s set -w synchronize-panes \; display-message "Sync: #{?window_sync,ON,OFF}" \; switch-client -T root
bind -T WINDOW_MODE a last-window \; switch-client -T root

# BreakPane / BreakPaneRight / BreakPaneLeft
bind -T WINDOW_MODE b break-pane \; switch-client -T root
bind -T WINDOW_MODE ']' break-pane \; swap-window -t +1 \; select-window -t +1 \; switch-client -T root
bind -T WINDOW_MODE '[' break-pane \; swap-window -t -1 \; select-window -t -1 \; switch-client -T root

# Quick selection of tabs 1..9
bind -T WINDOW_MODE 1 select-window -t 1
bind -T WINDOW_MODE 2 select-window -t 2
bind -T WINDOW_MODE 3 select-window -t 3
bind -T WINDOW_MODE 4 select-window -t 4
bind -T WINDOW_MODE 5 select-window -t 5
bind -T WINDOW_MODE 6 select-window -t 6
bind -T WINDOW_MODE 7 select-window -t 7
bind -T WINDOW_MODE 8 select-window -t 8
bind -T WINDOW_MODE 9 select-window -t 9

##### Resize mode #####
bind -r -T RESIZE_MODE h resize-pane -L 3
bind -r -T RESIZE_MODE j resize-pane -D 3
bind -r -T RESIZE_MODE k resize-pane -U 3
bind -r -T RESIZE_MODE l resize-pane -R 3
bind -r -T RESIZE_MODE H resize-pane -L 10
bind -r -T RESIZE_MODE J resize-pane -D 10
bind -r -T RESIZE_MODE K resize-pane -U 10
bind -r -T RESIZE_MODE L resize-pane -R 10
bind -r -T RESIZE_MODE = select-layout even-horizontal
bind -T RESIZE_MODE + select-layout even-vertical
bind -T RESIZE_MODE z resize-pane -Z


##### Session mode #####
bind -T SESSION_MODE d detach-client
bind -T SESSION_MODE w choose-tree -sZ
bind -T SESSION_MODE s choose-window -Z
bind -T SESSION_MODE : command-prompt \; switch-client -T root
bind -T SESSION_MODE c customize-mode -Z \; switch-client -T root

# "DumpScreen": save window layouts
unbind -T SESSION_MODE f
bind -T SESSION_MODE f run-shell -b 'tmux list-windows -a -F "#{session_name}:#{window_index} #{window_name} #{window_layout}" > "$HOME/IMPORTANT/tmux-layout.txt"' \; display-message 'Saved: ~/IMPORTANT/tmux-layout.txt'



##### Copy/Scroll (copy-mode-vi ≈ Zellij Scroll/Search) #####
bind -T copy-mode-vi G send -X end-of-buffer
bind -T copy-mode-vi j send -X cursor-down
bind -T copy-mode-vi k send -X cursor-up
bind -T copy-mode-vi C-f send -X page-down
bind -T copy-mode-vi C-b send -X page-up
bind -T copy-mode-vi l send -X page-down
bind -T copy-mode-vi h send -X page-up
bind -T copy-mode-vi d send -X halfpage-down
bind -T copy-mode-vi u send -X halfpage-up
bind -T copy-mode-vi s command-prompt -I "" -p "Search:" 'send -X search-forward "%%"'
bind -T copy-mode-vi n send -X search-forward
bind -T copy-mode-vi p send -X search-reverse
# Quickly view the buffer in a popup using less
bind -T copy-mode-vi e display-popup -E "/bin/zsh -c 'tmux capture-pane -pS -5000 | less'"


unbind -n C-f
# Simple “command palette”
bind -n C-M-f display-menu -T '#[align=centre]Commands' \
  'Split ▮'        v  'split-window -v' \
  'Split ▯'        n  'split-window -h' \
  'Toggle Sync'    s  'set -w synchronize-panes \; display-message "Sync: #{?window_sync,ON,OFF}"' \
  'Choose Window'  w  'choose-window -Z' \
  'Choose Session' S  'choose-tree -sZ' \
  'Rename Window'  r  'command-prompt -I "#W" { rename-window "%%" }' \
  'Rename Session' R  'command-prompt -I "#S" { rename-session "%%" }' \
  'New Window'     N  'new-window' \
  'Kill Pane'      x  'kill-pane' \
  'Kill Window'    X  'kill-window' \
  'list-keys'      ?  'run-shell "$XDG_CONFIG_HOME/tmux/scripts/popup-clue.sh"'\

# Clue
bind -T PANE_MODE    '?' run-shell '$XDG_CONFIG_HOME/tmux/scripts/popup-clue-pane.sh'
bind -T WINDOW_MODE  '?' run-shell '$XDG_CONFIG_HOME/tmux/scripts/popup-clue-window.sh'
bind -T RESIZE_MODE  '?' run-shell '$XDG_CONFIG_HOME/tmux/scripts/popup-clue-resize.sh'
bind -T SESSION_MODE '?' run-shell '$XDG_CONFIG_HOME/tmux/scripts/popup-clue-session.sh'



# Open lazygit popup
bind g display-popup -d "#{pane_current_path}" -w 80% -h 80% -E "lazygit"
bind -n M-g display-popup -d "#{pane_current_path}" -w 80% -h 80% -E "lazygit"
